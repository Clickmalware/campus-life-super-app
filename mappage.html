<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Grandview University — Campus Map</title>

    <!-- Leaflet CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-sA+e2kGk0X2Xqz4Q2q6n0s5rj3q3Rk/0qzLZ7qJbF0A="
        crossorigin=""
    />

    <!-- Leaflet Routing Machine CSS -->
    <link
        rel="stylesheet"
        href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
    />

    <style>
        html,body { height:100%; margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
        .app {
            display:flex;
            height:100vh;
            gap:12px;
            padding:12px;
            box-sizing:border-box;
            background:#f5f7fb;
        }
        .sidebar {
            width:320px;
            min-width:240px;
            max-width:36%;
            background:white;
            border-radius:8px;
            box-shadow:0 2px 10px rgba(20,30,40,0.08);
            padding:12px;
            overflow:auto;
        }
        .map-wrap {
            flex:1;
            border-radius:8px;
            overflow:hidden;
            box-shadow:0 2px 10px rgba(20,30,40,0.06);
        }
        #map { width:100%; height:100%; display:block; }
        h1 {
            font-size:18px;
            margin:6px 0 12px;
        }
        .poi {
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap:8px;
            padding:8px;
            border-radius:6px;
            cursor:pointer;
            transition:background .12s;
        }
        .poi:hover { background:#f3f6fb; }
        .poi .meta { display:flex; flex-direction:column; gap:2px; }
        .poi .name { font-weight:600; }
        .poi .desc { font-size:13px; color:#556; }
        .controls { display:flex; gap:8px; margin:8px 0; flex-wrap:wrap; }
        button { background:#0063f7; color:white; border:0; padding:8px 10px; border-radius:6px; cursor:pointer; }
        button.secondary { background:#e9eefb; color:#06357a; }
        .footer { margin-top:12px; font-size:13px; color:#556; }
        a.small { color:#0063f7; text-decoration:none; font-size:13px; }
        .credits { font-size:12px; color:#889; margin-top:8px; }
        @media (max-width:800px) {
            .app { flex-direction:column; }
            .sidebar { width:100%; max-width:none; height:34vh; min-height:220px; }
            .map-wrap { height:66vh; }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="sidebar">
            <h1>Grandview University — Campus Map</h1>
            <div class="controls">
                <button id="locateBtn">Find Me</button>
                <button id="clearRoute" class="secondary">Clear Route</button>
                <button id="zoomCampus" class="secondary">Zoom to Campus</button>
            </div>

            <div id="poiList"></div>

            <div class="footer">
                Click a place to highlight it. Use "Get directions" in a popup to route from your location.
                <div class="credits">Map tiles © OpenStreetMap contributors · Routing via OSRM demo server</div>
            </div>
        </div>

        <div class="map-wrap">
            <div id="map"></div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script
        src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-o9N1j7kFQ3p0vXQn0xwQG3vXk5Q5K4qf2RkR0iJ3zIY="
        crossorigin=""
    ></script>

    <!-- Control.Geocoder (search) -->
    <script src="https://unpkg.com/leaflet-control-geocoder@2.4.0/dist/Control.Geocoder.js"></script>

    <!-- Leaflet Routing Machine -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>

    <script>
        // Campus center (adjust to the real campus coordinates if available)
        const campusCenter = [41.6268, -93.6200]; // example coordinates

        // Points of interest around campus (example positions; update to match real campus)
        const pois = [
            { id: 'main', name: 'Main Entrance', desc: 'Main campus entrance & welcome center', coords: [41.6274, -93.6200] },
            { id: 'library', name: 'University Library', desc: 'Study spaces and resources', coords: [41.6270, -93.6184] },
            { id: 'studentcenter', name: 'Student Center', desc: 'Dining, lounge, student services', coords: [41.6261, -93.6193] },
            { id: 'science', name: 'Science Building', desc: 'Labs & classrooms', coords: [41.6262, -93.6212] },
            { id: 'parking', name: 'Parking Lot A', desc: 'Visitor parking', coords: [41.6280, -93.6195] },
            { id: 'health', name: 'Health & Wellness Center', desc: 'Medical and counseling', coords: [41.6253, -93.6189] },
            { id: 'bus', name: 'Campus Bus Stop', desc: 'Shuttle and transit connection', coords: [41.6266, -93.6178] },
            { id: 'sports', name: 'Sports Complex', desc: 'Gym, fields & courts', coords: [41.6248, -93.6208] }
        ];

        // Initialize map
        const map = L.map('map', {
            center: campusCenter,
            zoom: 16,
            maxZoom: 19
        });

        // Tile layer - OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // Add geocoder (search)
        const geocoder = L.Control.geocoder({
            defaultMarkGeocode: false
        }).addTo(map);

        geocoder.on('markgeocode', function(e) {
            map.setView(e.geocode.center, 18);
        });

        // Icon factory
        const icon = L.icon({
            iconUrl: 'https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png',
            iconSize: [25,41],
            iconAnchor: [12,41],
            popupAnchor: [1,-34]
        });

        // Add POI markers and list
        const markers = {};
        const poiListEl = document.getElementById('poiList');

        pois.forEach(p => {
            const m = L.marker(p.coords, { icon }).addTo(map);
            const popupContent = `
                <div style="min-width:200px">
                    <strong>${escapeHtml(p.name)}</strong><br/>
                    <small style="color:#444">${escapeHtml(p.desc)}</small>
                    <div style="margin-top:8px; display:flex; gap:8px;">
                        <button data-poi="${p.id}" class="goto" style="flex:1; padding:6px; border-radius:6px; border:0; background:#0063f7; color:#fff; cursor:pointer">Center</button>
                        <button data-poi="${p.id}" class="route" style="flex:1; padding:6px; border-radius:6px; border:0; background:#0a7; color:#fff; cursor:pointer">Get directions</button>
                    </div>
                </div>
            `;
            m.bindPopup(popupContent);
            markers[p.id] = m;

            // Sidebar entry
            const entry = document.createElement('div');
            entry.className = 'poi';
            entry.innerHTML = `
                <div class="meta">
                    <div class="name">${escapeHtml(p.name)}</div>
                    <div class="desc">${escapeHtml(p.desc)}</div>
                </div>
                <div style="display:flex;flex-direction:column;gap:6px;">
                    <button data-poi="${p.id}" class="goto" title="Center on map" style="padding:6px;border-radius:6px;border:0;background:#0063f7;color:#fff;cursor:pointer">View</button>
                </div>
            `;
            poiListEl.appendChild(entry);
            // click opens popup and centers
            entry.querySelector('.goto').addEventListener('click', () => {
                map.setView(p.coords, 18);
                markers[p.id].openPopup();
            });
        });

        // Utility to escape html in template strings
        function escapeHtml(s){
            return String(s).replace(/[&<>"'`=\/]/g, function (c) {
                return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#47;','=':'&#61;','`':'&#96;'}[c];
            });
        }

        // Routing control (created when needed)
        let routingControl = null;
        function clearRouting(){
            if(routingControl){
                map.removeControl(routingControl);
                routingControl = null;
            }
        }

        document.getElementById('clearRoute').addEventListener('click', clearRouting);
        document.getElementById('zoomCampus').addEventListener('click', () => {
            map.setView(campusCenter, 16);
        });

        // Handle popup button clicks (delegated)
        map.on('popupopen', function(e){
            const container = e.popup.getElement();
            if(!container) return;
            // Center button
            const gotoBtn = container.querySelector('button.goto');
            if(gotoBtn){
                gotoBtn.addEventListener('click', function(){
                    const id = this.getAttribute('data-poi');
                    const m = markers[id];
                    if(m){ map.setView(m.getLatLng(), 18); }
                });
            }
            // Route button
            const routeBtn = container.querySelector('button.route');
            if(routeBtn){
                routeBtn.addEventListener('click', function(){
                    const id = this.getAttribute('data-poi');
                    const dest = markers[id].getLatLng();
                    startRouteTo(dest);
                });
            }
        });

        // Sidebar and popup "Center" buttons also need delegation for inline created ones
        document.addEventListener('click', function(e){
            if(e.target && e.target.matches('button.goto')){
                const id = e.target.getAttribute('data-poi');
                if(id && markers[id]){
                    map.setView(markers[id].getLatLng(), 18);
                    markers[id].openPopup();
                }
            }
            if(e.target && e.target.matches('button.route')){
                const id = e.target.getAttribute('data-poi');
                if(id && markers[id]){
                    startRouteTo(markers[id].getLatLng());
                    markers[id].openPopup();
                }
            }
        });

        // Find user location button
        document.getElementById('locateBtn').addEventListener('click', () => {
            map.locate({ setView: true, maxZoom: 17 });
        });

        // Listen for locationfound
        let lastUserLocation = null;
        map.on('locationfound', function(e){
            lastUserLocation = e.latlng;
            // add or move user marker
            if(!map._userMarker){
                map._userMarker = L.circleMarker(e.latlng, { radius:8, color:'#0063f7', fillColor:'#cfe6ff', fillOpacity:0.9 }).addTo(map).bindPopup('You are here');
            } else {
                map._userMarker.setLatLng(e.latlng);
            }
            map._userMarker.openPopup();
        });

        map.on('locationerror', function(){
            alert('Could not determine your location. Please allow location access in your browser.');
        });

        // Start route: from current location (if available) or prompt to click map to set start
        function startRouteTo(destinationLatLng){
            clearRouting();
            // Prefer lastUserLocation
            if(lastUserLocation){
                routingControl = L.Routing.control({
                    waypoints: [
                        L.latLng(lastUserLocation.lat, lastUserLocation.lng),
                        destinationLatLng
                    ],
                    routeWhileDragging: false,
                    showAlternatives: false,
                    lineOptions: { styles: [{ color: '#0063f7', opacity: 0.8, weight: 6 }] },
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1'
                    }),
                    createMarker: function(i, wp, n) {
                        // Custom start/end markers
                        const options = { draggable: false };
                        if(i === 0){
                            return L.marker(wp.latLng, { title: 'Start (you)', icon: L.divIcon({ className: 'start-icon', html: '📍', iconSize: [20,20] }) });
                        } else {
                            return L.marker(wp.latLng, { title: 'Destination', icon });
                        }
                    }
                }).addTo(map);
            } else {
                // Ask user to click map for start point
                alert('No detected current location. Click on the map to pick a starting point for directions.');
                const clickHandler = function(e){
                    const start = e.latlng;
                    map.off('click', clickHandler);
                    routingControl = L.Routing.control({
                        waypoints: [
                            start,
                            destinationLatLng
                        ],
                        routeWhileDragging: false,
                        showAlternatives: false,
                        router: L.Routing.osrmv1({
                            serviceUrl: 'https://router.project-osrm.org/route/v1'
                        }),
                        lineOptions: { styles: [{ color: '#0063f7', opacity: 0.8, weight: 6 }] }
                    }).addTo(map);
                };
                map.on('click', clickHandler);
            }
        }

        // Fit map to show all POIs and campus
        (function fitAll(){
            const group = L.featureGroup(Object.values(markers));
            map.fitBounds(group.getBounds().pad(0.3));
        })();

    </script>
</body>
</html>